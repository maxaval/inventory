<form method="post" action="" id="csvForm">
    {% csrf_token %}
  
    <div class="modal-header">
        <h5 class="modal-title">Importar Archivo CSV</h5> 
        <button type="button" class="close pull-right" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      
    </div>
  
    <div class="modal-body">
      {% for field in form %}
        <div class="form-group{% if field.errors %} invalid{% endif %}">
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
          {{ field }}
          {% for error in field.errors %}
            <p class="help-block">{{ error }}</p>
          {% endfor %}
        </div>
      {% endfor %}
      <progress value="0" max="100" id="progreso-barra"></progress>
    </div>
  
    <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
      <button type="button" onclick="procesarCSV()" class="btn btn-secondary">Procesar CSV</button>
    </div>
  
</form>

{% block scriptbottom %}
<script>
    function procesarCSV() {
        var form = document.getElementById('csvForm');
        var formData = new FormData(form);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', "{% url 'inventario:procesar_csv' %}", true);

        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                var porcentaje = (e.loaded / e.total) * 100;
                document.getElementById('progreso-barra').value = porcentaje;
            }
        };

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                if (xhr.status == 200) {
                    var respuesta = JSON.parse(xhr.responseText);

                    // Actualizar la barra de progreso despu√©s de recibir la respuesta JSON
                    if (respuesta && respuesta.progreso) {
                        document.getElementById('progreso-barra').value = respuesta.progreso[respuesta.progreso.length - 1];
                    }

                    // Manejar la respuesta si es necesario (puede que quieras mostrar un mensaje)

                    // Redirigir a la URL inventario:categorialist
                    // window.location.href = "{% url 'inventario:categorialist' %}";
                } else {
                    // Manejar errores si es necesario
                    console.error('Error al procesar el CSV:', xhr.statusText);
                }
            }
        };

        xhr.send(formData);
    }
</script>
{% endblock %}
